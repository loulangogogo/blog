## 案例特训架构设计篇-内容提要【277】

- 软件架构风格
- 质量属性与架构评估
- web 架构综合考察



## 架构风格【278】

- 什么是软件架构风格



## 架构评估【279】

#### 质量属性

- **性能**
- 可靠性
  - 容错
  - 健壮性
- **可用性**
- **安全性**
- **可修改性**
  - 可维护性
  - 可扩展性
  - 结构重组
  - 可移植性
- 功能性
- 可变性
- 互操作性

## 评估

- 敏感点
- 权衡点
- 风险点
- 非风险点



## web架构综合考查-内容提要【280】

- 高性能
- 高可用
- 可维护
- 应变
- 安全



## 单机到应用与数据分离【281】

## 集群与负载均衡【282】

### 应用层负载均衡

> **http 重定向**：http 重定向就是应用层的请求转发。用户的请求其实已经到了 http 重定向负载均衡服务器，服务器根据算法要求用户重定向，用户收到重定向请求后，再次请求真正的集群。
>
> **特定：**实现简单，但是性能较差

> **反向代理服务器：**在用户的请求到达反向代理服务器时（已经到达网站机房），有反向代理服务器根据算法转发到具体的服务器。常用的 apache、nginx 都可以充当反向打理服务器。
>
> **特点：**部署简单，但代理服务器可能成为性能瓶颈。

### 传输层负载均衡

> **DNS 域名解析负载均衡：**DNS 域名解析负载均衡就是在用户请求 DNS 服务器，获取域名对应的 IP 地址时，DNS 服务器直接给出负载均衡后的服务器 IP。
>
> **特点：**效率比 HTTP 重定向高，减少维护负载均衡服务器成本。但一个应用服务器故障，不能及时通知 DNS，而且 DNS 负载均衡的控制权在域名服务商哪里，万战无法做更多的改善和更强大的管理。

> **基于 NAT 的负载均衡：**局域 NAT 的负载均衡将一个外部 IP 地址映射为多个 IP 地址，对每次连接 请求动态的转换为一个内部节点的地址。
>
> **特点：**技术较为成熟，一般在网关位置，可以通过硬件实现。像四层交换机一般就采用这种技术。



### 负载均衡的算法

#### 静态算法（不考虑动态负载）

1. **轮转算法**：轮流将服务请求（任务）调度给不同的节点（即：服务器）
2. **加权轮转算法**：考虑不同节点处理能力的差异。
3. **源地址哈希散列算法**：根据请求的源 IP 地址，作为散列健从静态分配的散列表找出对应的节点。
4. 目标地址哈希散列算法：根据请求目标 IP 做散列找出对应的节点。
5. **随机算法**：随机分配，简单，但不可控。

#### 动态算法（考虑动态负载）

1. **最小连接数算法**：新请求分配给当前活动请求数量最少的节点，每个节点处理能力相当的情况下。
2. **加权最小连接数算法**：考虑节点处理能力不同，按最小连接数分配。
3. **加权百分比算法**：考虑了节点的利用率、硬盘速率、进程个数等，使用利用率来表现剩余处理能力。



## 集群与有状态无状态服务【283】

#### 无状态服务

> 对单词请求的处理，不依赖其他请求，也就是说，处理一次请求所需的全部信息，要么包含在这个请求里，要么可以从外部获取到（比如说数据库），服务器本身不存储任何信息。

#### 有状态服务

> 他会在自身保存一些数据，先后的请求时有关联的。



## ORM【284】

持久化技术--ORM



## 数据库读写分离【285】

#### 主从数据库结构特点

1. 一般：一主多从，也可以多主多从
2. 主库做写操作，从库做读操作。

#### 主从复制步骤

1. 主库跟新数据完成之前，将操作写 binlog 日志文件
2. 从库打开 IO 线程与主库连接，做 binlog dump process，并将时间写入中继日志。
3. 从库执行中继日志时间，保持与主库一致。



## 数据库缓冲 Memcache 与Redis【286】

### 常见的缓冲技术

#### Memcache

> 是一个高性能的分布式的内存对象缓冲系统，用于动态 web 应用以减轻数据库负载。Memcache 通过在内存里维护一个统一的巨大的 hash 表，他能够用来存储各种格式的数据，包括图像、视频、文件以及数据库检索的结果等。

#### Redis

> Redis 是一个开源使用的 ANSIC 语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库，并提供多种语言的 API。

#### Squid

> 是一个高性能的代理缓存服务器，Squid 支持 FTP、gopher、HTTP 和 HTTPS 协议。



## Reids数据分片【287】

### Redis集群切片的常见方式

- 客户端分片
- 中间件实现分片
- 客户端服务端协作分片



### Redis分片方案

- 范围分片
- 哈希分片
- 一致性哈希分片



## Redis分布式存储【288】

- 主从模式
- 哨兵模式
- 集群模式



## Redis数据类型【289】

- String（字符串）
- Hash（字典）
- list（列表）
- Set（集合）
- Zset（sorted Set）（有序集合 ）



## Redis数据淘汰算法【290】

- 不淘汰
  - noeviction：禁止驱逐数据，内存不足以容纳新如数据时。新的写入操作就会报错。系统默认的一种淘汰算法。
- 设置过期时间的健空间
  - volatile-random：随机移除某个 key
  - volatile-lru：优先移除最近未使用的 key
  - vaolatile-ttl：ttl 只小的 key 优先移除
- 全键空间
  - allkeys-random：随机移除某个 key
  - allkeys-lru：优先移除最近未使用的 key



## Redis数据持久化RDB与AOF【291】

- RDB：传统数据库快照思想。按照指定时间间隔将数据进行快照存储。
- AOF：传统数据库中日志的思想，把每条改变数据集的命令追加到 AOF 文件末尾，这样出问题了，可以重新执行 AOF 文件中的命令来重建数据集。



## Redis常见问题

#### 缓冲雪崩

1. 使用锁或队列：保证不会有大量的线程对数据库进行一次性的读写完，从而避免失效时大量的并发请求落到底层存储系统上。
2. 为 key 设置不同的缓冲失效时间：在固定一个缓冲时间的基础上+随机一个时间作为缓冲失效时间。
3. 二级缓冲：设置一个有时间限制的缓冲+一个无线时间限制的缓冲，防止大规模访问数据库。



#### 缓冲穿透

1. 如果查询结果为空，直接设置一个默认值放到缓冲，这样第二次到缓冲中获取就有值了。设置一个不超过 5 分钟的过期时间，以便能正常更新缓冲数据库。
2. 设置布隆过滤器，将所有可能存在的数据哈希到一个足够大的 bitmap 中，一个一定不存在的数据会被这个 bitmap 拦截掉，从而避免了对底层存储系统的查询压力。



#### 缓冲预热

1. 直接写个缓冲刷新页面，上线时手工操作
2. 数据量不大的时候，可以在项目启动的时候自动进行加载。
3. 定时刷新缓冲。



#### 缓冲更新

1. 定时清理过期缓冲。
2. 当有用户请求过来时，在判断这个请求所用到的缓冲是否过期，过期的话就去底层系统得到新数据并更新缓冲。



 #### 缓冲降级

> 降级的目的时保证核心服务可用，即使时有损的，而且有些服务时无法降级的（如电商的购物流程等），在进行降级之前要对系统进行梳理，从而梳理出哪些必须保护，哪些可降级。



## CDN【293】

> CND 的全称时 Content Delivery Network，即内容分发网络。其基本思路就是尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环境，时内容传输更快、更稳定。





## XML与JSON【294】



## WEB 应用服务器【295】

- WEB应用服务器可以理解为两层意思
  - WEB 服务器：其职能较为 单一，就是把浏览器发过来的 Request 请求，返回 Html 页面。
  - 应用服务器：进行业务逻辑处理。

> #### 常见的web服务器
>
> - Apache
> - IIS
> - Tomcat
> - JBOSS
> - WebSphere
> - WebLogic
> - Jetty



## REST【296】

Rest 是一种只使用 Http 和 XML 进行基于 web 通信的技术，可以降低开发的复杂性，提高系统的可伸缩性。

> #### REST 的 5 个原则
>
> 1. 网络上的所有事物都被抽象为资源
> 2. 每个资源对应一个唯一的资源标识
> 3. 通过通用的连接件接口对资源进行操作。
> 4. 对资源的各种操作不会改变资源标识
> 5. 所有的操作都是无状态的。



## 响应式Web设计【297】



## 中台基本概念【298】

> 大中台，小前台



## Web分层架构【299】

