## 云原生架构概述

### 一、云原生的背景、定义和特征

> **背景**：P482

> [!tip]
>
> **定义**：
>
> 从技术角度，云原生架构是基于云原生技术的一组架构原则和设计模式的集合，旨在将云应用中的非业务代码部分进行最大化的剥离，从而让云设施接管应用中原有的大量非功能特性（入弹性、韧性、安全、可观测性、灰度等），使业务不再有非功能性业务终端困扰的同时，具备轻量、敏捷、高度自动化的特定。由于云原生是面向是面向“云”而设计的应用，因此，技术部分依赖于传统云计算的3层概念，即基础设施服务（IaaS）、平台即服务（PaaS）和软件即服务（SaaS）。

> [!tip]
>
> **特征**：
>
> 1. 代码结构发生巨大变化
> 2. 非功能性特性大量委托
> 3. 高度自动化的软件交付

### 二、云原生架架构的设计背景

**云原生架构原则**

1. 服务化原则
2. 弹性原则
3. 可观测原则
4. 韧性原则
5. 所有过程自动化原则
6. 零信任原则
7. 架构持续演进原则

### 三、架构模式（服务化机构模式、Mesh化架构模式、Serverless模式、存储计算分离模式、分布式事务模式、可观测架构和事件驱动架构）

1. 服务化架构模式

   > 服务化架构是云时代构建云原生应用的标准架构模式，要求以应用模块为颗粒度划分一个软件，以接口契约定义彼此业务关系，以标准协议（HTTP、GRPC等）去报彼此的互联互通，结合DDD（领域模型驱动）、TDD（测试驱动开发）、容器化部署提升每个接口的代码质量和迭代速度。

2. Mash化架构模式

   > Mash化架构是把中间件框架（入PPC、缓冲、异步消息等）从业务进程中分离，让中间件SDK与业务代码进一步解耦，从而使得中间件升级对业务进程没有影响，甚至迁移到另外一个平台的中间件对业务透明。

3. Serverless模式

   > Serverless将“部署”这个动作从运维中“收走”，使开发者不用关心应用运行地点、操作系统、网络配置、CPU性能等，从架构抽象上看，当业务流量到来;业务事件发生时，云会启动或调度一个已启动的业务进程进行处理，处理完成后自动会关闭/调度业务进程，等待下一次出发，也就是把应用的整个运行都委托给云。

4. 存储计算分离模式

   > 分布式环境中的CAP困难主要是针对有状态的应用，因为无状态的应用不存在C（一致性）这个维度，因此可以获得很好的A（可用性）和P（分区容错性），因而获得更好的弹性。在云环境中，推荐把各类暂态数据、结构化和非结构化数据都采用云服务来保存，从而实现存储分离。

5. 分布式事务模式

   > 微服务模式提倡每个服务使用私有数据源，而不是像单一这样共享数据源，但往往大颗粒度的业务需要访问多个微服务，必然带来分布式事务问题，否则数据就会出现不一致。架构师需要根据不同的场景选择不同的分布式事务模式。
   >
   > - 传统采用XA模式，虽然具备很强的一致性，但是性能差。
   > - 基于消息的最终一致性（BASE）通常由很高的性能，但是通用性有限。
   > - TCC模式完全由应用层来控制事务，事务隔离性可控，也可以做到比较搞笑；但是对业务的侵入性非常强，设计开发维护成本较高。
   > - SAGA模式与TCC模式的优缺点雷士但没有try这个阶段，而是每个正向事务都对应一个补偿事务，也是开发维护成本高。
   > - 开源项目SEATA的AT模式非常高性能，且无代码的开发工作量，且可以自动执行回滚操作，同时也存在一些使用场景限制。

6. 可观测架构

   > 可观测架构包括Logging、Tracing、Metrics三个方面，其中Logging提供多个级别 (verbose/ debug/warning/error/fatal) 的详细信息跟踪，由应用开发者主动提供; Tracing提供一个请求从前 端到后端的完整调用链路跟踪，对于分布式场景尤其有用; Metrics 则提供对系统量化的多维度 度量。

7. 事件驱动架构

   > 事件驱动架构本质上是一种应用/组件间的集成架构模式。
   >
   > 事件和传统消息不同，事件具有schema,所以可以校验event的有效性，同时EDA具备QoS保障机制，也能对事件处理失败进行响应。事件驱动架构不仅用于（微）服务解耦，还可以应用于下面的场景：
   >
   > - 增强服务韧性：由于服务间的异步集成的，也就是下游任何的处理失败甚至党纪都不会被上游感知，自然也就不会对上游带来影响。
   > - CQPS：把丢服务状态由影响的命令用事件发起，而对服务状态没有影响的查询才使用同步调用的API。
   > - 数据变化的通知：在服务架构下，往往一个服务中的数据发生变化，另外的服务会感兴趣，比如用户订单完成后，积分服务、信用服务等都需要得到事件通知并更新用户积分和信用等级。
   > - 构建开放式接口：在EDA下，事件的提供者并不关心有哪些订阅者，不像服务调用的场景--数据的差生需要知道数据的消费者在哪里并调用它，因此保持的了接口的开放性。
   > - 事件流处理：应用于大量事件流（而非离散事件）的数据分析场景，典型应用是基于Kafka的日志处理。
